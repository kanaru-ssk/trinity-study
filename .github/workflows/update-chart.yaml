name: Update Chart

on:
  schedule:
    - cron: "0 0 1 * *" # 毎月1日の00:00に実行
  workflow_dispatch:    # actionの手動実行を可能にする

permissions:
  contents: write        # ブランチ作成・コミットに必要
  pull-requests: write   # PR 作成に必要

jobs:
  update-chart:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          persist-credentials: true   # push するために必要
          fetch-depth: 0              # push するために必要
      - name: Use Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 24
      - name: Cache npm directory
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: ${{ runner.os }}-npm-
      - name: Install dependencies
        run: npm ci
      - name: Update
        run: npm run update
        env:
          EXCHANGE_RATE_API_KEY: ${{ secrets.EXCHANGE_RATE_API_KEY }}
      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Automated update public/chart.csv"
          title: "Update public/chart.csv"
          body: |
            This pull request was automatically generated by the "Update Chart" workflow.
          base: main                     # PR の宛先ブランチ
          branch: chore/update-chart     # 作成されるブランチ名のプレフィックス
          branch-suffix: timestamp       # chore/update-chart-20251115-xxxx のように一意にする
          labels: |
            automated
            chart
      - name: Auto merge PR
        if: ${{ steps.cpr.outputs.pull-request-url != '' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_URL: ${{ steps.cpr.outputs.pull-request-url }}
        run: |
          gh pr merge "$PR_URL" --auto --merge
      - name: Deploy
        uses: ./.github/workflows/deploy.yaml
